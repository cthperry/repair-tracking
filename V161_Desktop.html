<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="icon" href="data:,">
  <title>ç¶­ä¿®è¿½è¹¤ç³»çµ± - Desktop</title>
  
  <!-- ========================================
       ${AppConfig.getFullVersion()}
       é€™æ˜¯ä¸€å€‹å…¨æ–°çš„æ¨¡çµ„åŒ–æ¶æ§‹
       æ ¸å¿ƒç†å¿µï¼šç©©å®šæ€§ã€å¯ç¶­è­·æ€§ã€æ•ˆèƒ½
       ======================================== -->
  
  <style>
    /* ========================================
       Reset & Base Styles
       ======================================== */
    * {
      box-sizing: border-box;
      margin: 0;
      padding: 0;
    }
    
    body {
      line-height: 1.5;
      -webkit-font-smoothing: antialiased;
      text-rendering: geometricPrecision;

      font-size: 14px;

      font-family: \"Noto Sans TC\", \"Microsoft JhengHei\", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 600px at 0% 0%, var(--module-accent-soft), transparent 55%),
        radial-gradient(900px 520px at 100% 0%, rgba(14, 165, 233, 0.06), transparent 60%),
        linear-gradient(180deg, var(--color-background) 0%, var(--color-surface-muted) 100%);
      background-attachment: fixed;
      color: var(--color-text);
      overflow-x: hidden;
    }
    
    /* åŸºç¤è®Šæ•¸ï¼ˆæœƒè¢« config.js è¦†å¯«ï¼‰ */
            :root {
      /* ä¼æ¥­ç´š B2Bï¼šä½å½©åº¦ã€å±¤æ¬¡æ¸…æ¥šï¼ˆV161.092 è¦–è¦ºå±¤æ¬¡/æ¨¡çµ„ Accentï¼‰ */
      --color-primary: #2563eb;
      --color-primary-hover: #1d4ed8;
      --color-primary-soft: rgba(37, 99, 235, 0.10);
      --color-secondary: #0ea5e9;
      --color-success: #16a34a;
      --color-warning: #d97706;
      --color-error: #dc2626;

      /* ä¸‰å±¤èƒŒæ™¯ï¼šç¨æ·±åº•è‰² + ç™½è‰²é¢æ¿ + ç™½è‰²å¡ç‰‡ */
      --color-background: #f4f6fb;
      --color-surface: #ffffff;
      --color-surface-muted: #f2f5fa;
      --color-panel: #ffffff;
      --color-panel-alt: #f7f9fd;

      --color-text: #0f172a;
      --color-text-secondary: #475569;
      --color-border: #dbe2ef;
      --color-shadow: rgba(15, 23, 42, 0.08);
      --color-backdrop: rgba(15, 23, 42, 0.40);

      /* æ¨¡çµ„ Accentï¼ˆé è¨­=primaryï¼›ç”± core/theme.js ä¾è·¯ç”±å‹•æ…‹è¦†å¯«ï¼‰ */
      --module-accent: var(--color-primary);
      --module-accent-ink: var(--color-primary);
      --module-accent-soft: var(--color-primary-soft);
      --focus-ring: var(--color-primary-soft);

      /* é™°å½±ä¸‹ä¿®ï¼šé¿å…ã€Œæ¼‚æµ®ç©å…·æ„Ÿã€ */
      --shadow-sm: 0 1px 2px rgba(15, 23, 42, 0.05);
      --shadow-md: 0 6px 18px rgba(15, 23, 42, 0.10);
      --shadow-lg: 0 16px 36px rgba(15, 23, 42, 0.14);

      --radius-sm: 10px;
      --radius-md: 12px;
      --radius-lg: 14px;
      --ring: 0 0 0 3px var(--focus-ring);
    }
    /* ========================================
       Loading Screen (ç”± Bootstrap æ¸²æŸ“)
       ======================================== */
    /* Bootstrap æœƒå‹•æ…‹æ’å…¥è¼‰å…¥ç•«é¢ */
    
    /* ========================================
       Login Screen (ç”± Auth æ¸²æŸ“)
       ======================================== */
    /* Auth æœƒå‹•æ…‹æ’å…¥ç™»å…¥è¡¨å–® */
    
    /* ========================================
       Main App Layout (ç™»å…¥å¾Œé¡¯ç¤º)
       ======================================== */
    .app {
      display: flex;
      min-height: 100vh;
      width: 100%;
      max-width: 100vw;
      overflow-x: hidden;
    }
    
    aside {
      width: 248px;
      background: linear-gradient(180deg, rgba(255,255,255,0.92) 0%, rgba(247,249,253,0.92) 100%);
      border-right: 1px solid var(--color-border);
      color: var(--color-text);
      padding: 12px 12px;
      position: sticky;
      top: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      gap: 12px;
      backdrop-filter: blur(10px);
    }
    
    main {
      flex: 1;
      display: flex;
      flex-direction: column;
      width: 100%;
      max-width: 100%;
      overflow-x: hidden;
    }
    
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 16px;
      border-bottom: 1px solid var(--color-border);
      background: linear-gradient(180deg, rgba(255,255,255,0.90) 0%, rgba(247,249,253,0.90) 100%);
      position: sticky;
      top: 0;
      z-index: 20;
      backdrop-filter: blur(10px);
    }

    .header-left{display:flex;flex-direction:column;gap:2px;min-width:0;}
    .header-title{font-weight:900;font-size:14px;color:var(--color-text);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .header-subtitle{font-size:12px;color:var(--color-text-secondary);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;}
    .header-right{display:flex;align-items:center;gap:10px;}
    
    .brand {
      font-weight: 800;
      font-size: 14px;
      color: var(--color-text);
      letter-spacing: 0.2px;
    }

    .brand-badge{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:4px 10px;
      border-radius:999px;
      background: var(--module-accent-soft);
      border: 1px solid rgba(37,99,235,0.18);
      color: var(--module-accent-ink);
      font-weight: 900;
      font-size: 12px;
      margin-left: 8px;
    }

    .user-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(148,163,184,.45);
      background: rgba(255,255,255,.65);
    }
    .user-avatar{
      width:26px;height:26px;border-radius:999px;
      display:flex;align-items:center;justify-content:center;
      background: var(--module-accent-soft);
      color: var(--module-accent-ink);
      font-weight: 900;
      font-size: 12px;
    }
    .user-name{font-weight:800;font-size:13px;color:var(--color-text);max-width:120px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;}

    .sidebar-header{padding: 10px 10px 0 10px;}
    .sidebar-title{font-weight:900;font-size:14px;color:var(--color-text);}
    .sidebar-sub{margin-top:4px;}

    .sidebar-nav{padding: 0 10px; flex: 1; overflow-y: auto;}

    .sidebar-footer{padding: 0 10px 10px 10px;}
    
    /* ========================================
       Utility Classes
       ======================================== */
    .muted {
      color: var(--color-text-secondary);
      font-size: 12px;
    }
    
    .right {
      margin-left: auto;
    }
    
    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      height: 34px;
      padding: 0 12px;
      background: var(--color-surface);
      color: var(--color-text);
      border: 1px solid var(--color-border);
      border-radius: 10px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: background 0.18s ease, border-color 0.18s ease, box-shadow 0.18s ease;
      user-select: none;
    }
    
    .btn:hover { background: var(--color-panel-alt); }

    /* ä¼æ¥­ç³»çµ±é¿å…éåº¦ã€Œå½ˆè·³/æ¼‚æµ®ã€å‹•æ•ˆ */
    .btn:active{transform:none;}
    .btn:focus{outline:none;box-shadow: var(--ring);border-color:var(--module-accent);}
    
    .btn.primary {
      background: var(--color-primary);
      color: white;
      border-color: var(--color-primary);
    }
    
    .btn.primary:hover {
      background: var(--color-primary-hover);
    }

    .btn.danger{background:var(--color-error);border-color:var(--color-error);color:#fff;}
    .btn.danger:hover{filter:brightness(0.95);}

    .btn.ghost{background:transparent;}
    .btn.ghost:hover{background: var(--color-background);}

    .input{width:100%;padding:10px 12px;border:1px solid var(--color-border);background:var(--color-surface);color:var(--color-text);border-radius:10px;font-size:14px;outline:none;}
    .input:focus{border-color:var(--module-accent);box-shadow: var(--ring);}
    textarea.input{resize:vertical;}
    select.input{background:var(--color-surface);}
  
    /* ========================================
       Navigation
       ======================================== */
    .nav-title{color:var(--color-text-secondary);font-size:12px;margin-bottom:8px;}
    .nav-item{padding:10px 10px;border-radius:10px;margin-bottom:6px;cursor:pointer;display:flex;align-items:center;gap:8px;color:var(--color-text-secondary);border:1px solid transparent;user-select:none;}
    .nav-item:hover{background:rgba(148,163,184,.08);border-color:rgba(148,163,184,.18);color:var(--color-text);}
    .nav-item.active{background:var(--module-accent-soft);box-shadow: inset 3px 0 0 var(--module-accent);border-radius:10px;color:var(--module-accent-ink);}
    .nav-item.disabled{cursor:not-allowed;opacity:.5;}
    .nav-item.disabled:hover{background:transparent;border-color:transparent;color:var(--color-text-secondary);}
  </style>

  <!-- Core UI Kitï¼ˆçµ±ä¸€ Desktop/Mobile å…ƒä»¶æ¨£å¼ï¼‰ -->
  <link rel="stylesheet" href="core/ui.css">
</head>
<body>
  <!-- ========================================
       æ‰€æœ‰ UI éƒ½ç”± JavaScript å‹•æ…‹æ¸²æŸ“
       é€™è£¡åªä¿ç•™æœ€åŸºæœ¬çš„å®¹å™¨
       ======================================== -->
  
  <!-- Firebase SDK (CDN) -->
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib@1.17.1/dist/pdf-lib.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/@pdf-lib/fontkit@1.1.1/dist/fontkit.umd.min.js"></script>
  
  <!-- ========================================
       æ ¸å¿ƒæ¨¡çµ„è¼‰å…¥é †åºï¼ˆé—œéµï¼ï¼‰
       1. Config (é…ç½®)
       2. ErrorHandler (éŒ¯èª¤è™•ç†)
       3. Bootstrap (ç³»çµ±å•Ÿå‹•)
       4. Auth (èªè­‰)
       ======================================== -->
  
  <!-- Step 1: è¼‰å…¥é…ç½® -->
  <script src="core/config.js"></script>

  
  <script src="core/utils/strings.js"></script>
  <script src="core/utils/time.js"></script>
  <script src="core/utils/dom.js"></script>
<!-- Step 1.2: å…±ç”¨å·¥å…·ï¼ˆæ—¥æœŸ/æœå‹™åˆå§‹åŒ–ç­‰ï¼‰ -->
  <script src="core/utils.js"></script>
  <script src="core/registry.js"></script>
  <script src="core/app-state.js"></script>

  <!-- Step 1.5: ä¸»é¡Œ/é…è‰²ï¼ˆæ¨¡çµ„ Accentï¼‰ -->
  <script src="core/theme.js"></script>
  <script src="core/ui.js"></script>
  <script src="core/saved-views.js"></script>
  <script src="core/form-validate.js"></script>
  <script src="core/listPaging.js"></script>
  
  <!-- Step 2: è¼‰å…¥éŒ¯èª¤è™•ç†å™¨ -->
  <script src="core/error-handler.js"></script>
  
  <!-- Step 3: è¼‰å…¥å•Ÿå‹•å™¨ -->
  <script src="core/bootstrap.js"></script>
  
  <!-- Step 4: è¼‰å…¥èªè­‰ç³»çµ± -->
  <script src="core/auth.js"></script>
  <script src="core/user-admin.js"></script>
  <script src="core/linkage.js"></script>
  <script src="core/module-loader.js"></script>
  
  <!-- ========================================
       å®¢æˆ¶ç®¡ç†æ¨¡çµ„ï¼ˆç™»å…¥å¾Œè¼‰å…¥ï¼‰
       ======================================== -->
  <script src="features/customers/customers.model.js"></script>
  <script src="features/customers/customers.service.js"></script>

<!-- ========================================
       ç¶­ä¿®ç®¡ç†æ¨¡çµ„ï¼ˆç™»å…¥å¾Œè¼‰å…¥ï¼‰
       ======================================== -->
  <script src="features/repairs/repairs.model.js"></script>
  <script src="features/repairs/repairs.service.js"></script>

  <!-- ========================================
       æ©Ÿå°æ­·å²æ¨¡çµ„ï¼ˆç™»å…¥å¾Œè¼‰å…¥ï¼‰
       ======================================== -->

  <!-- ========================================
       è¨­å®šæ¨¡çµ„
       ======================================== -->
  <script src="features/settings/settings.model.js"></script>
  <script src="features/settings/settings.service.js"></script>
  <!-- Repair Templates (V161.105) -->
  <script src="features/templates/repairTemplates.model.js"></script>
  <script src="features/templates/repairTemplates.service.js"></script>

  <!-- ========================================
       ä½¿ç”¨è€…æ“ä½œæŒ‡å—
       ======================================== -->


  
  
  
  <!-- ========================================
       çŸ¥è­˜åº«ï¼ˆKB-1ï¼‰
       ======================================== -->
  <script src="features/kb/kb.model.js"></script>
  <script src="features/kb/kb.service.js"></script>

  <!-- ========================================
       æ©Ÿå°ä¿é¤Šç®¡ç†ï¼ˆMNT-1ï¼‰
       ======================================== -->
  <script src="features/maintenance/maintenance.model.js"></script>
  <script src="features/maintenance/maintenance.service.js"></script>

<!-- ========================================
       é€±å ±æ¨¡çµ„
       ======================================== -->
  <script src="features/weekly/weekly.model.js"></script>
  <script src="features/weekly/weekly.service.js"></script>

  <!-- ========================================
       é›¶ä»¶ç®¡ç†æ¨¡çµ„
       ======================================== -->
  <script src="features/parts/parts.model.js"></script>
  <script src="features/parts/parts.service.js"></script>

  <!-- ========================================
       å ±åƒ¹ç®¡ç†æ¨¡çµ„
       ======================================== -->
  <script src="features/quotes/quotes.model.js"></script>
  <script src="features/quotes/quotes.service.js"></script>

  <!-- ========================================
       è¨‚å–®/æ¡è³¼è¿½è¹¤æ¨¡çµ„
       ======================================== -->
  <script src="features/orders/orders.model.js"></script>
  <script src="features/orders/orders.service.js"></script>
  
  <!-- ========================================
       ä¸»æ‡‰ç”¨ç¨‹å¼ï¼ˆç™»å…¥å¾Œæ‰è¼‰å…¥ï¼‰
       ======================================== -->
  <script>
    /**
     * ä¸»æ‡‰ç”¨ç¨‹å¼åˆå§‹åŒ–
     * é€™æ®µç¨‹å¼åªåœ¨ç™»å…¥æˆåŠŸå¾ŒåŸ·è¡Œ
     */
    
    /**
     * ç°¡æ˜“ Routerï¼ˆDesktop/Mobile å…±ç”¨æ¦‚å¿µï¼‰
     */
    class _AppRouter {
      constructor(containerId) {
        this.containerId = containerId;
        this.current = null;
        this.currentFeature = null;
        this.isNavigating = false;
      }

      _routeMeta(route){
        const map = {
          repairs:   { title: 'ğŸ“‹ ç¶­ä¿®ç®¡ç†', subtitle: 'ç¶­ä¿®å–®å»ºç«‹ï¼é€²åº¦è¿½è¹¤ï¼æ­·å²ç´€éŒ„' },
          machines:  { title: 'ğŸ–¥ï¸ æ©Ÿå°æ­·å²', subtitle: 'ä¾åºè™Ÿå¿«é€ŸæŸ¥è©¢ç¶­ä¿®æ­·å²' },
          maintenance: { title: 'ğŸ› ï¸ æ©Ÿå°ä¿é¤Š', subtitle: 'è¨­å‚™ç®¡ç†ï¼ä¿é¤Šç´€éŒ„ï¼æé†’ï¼å ±è¡¨' },
          customers: { title: 'ğŸ‘¥ å®¢æˆ¶ç®¡ç†', subtitle: 'å…¬å¸ï¼è¯çµ¡äººè³‡æ–™ç¶­è­·èˆ‡é‡˜é¸' },
          parts:     { title: 'ğŸ§© é›¶ä»¶è¿½è¹¤', subtitle: 'éœ€æ±‚ â†’ å ±åƒ¹ â†’ ä¸‹å–® â†’ åˆ°è²¨ â†’ æ›´æ›' },
          quotes:    { title: 'ğŸ§¾ å ±åƒ¹ç®¡ç†', subtitle: 'å»ºç«‹å ±åƒ¹å–®ä¸¦è¿½è¹¤æ ¸å‡†/é€å‡ºç‹€æ…‹' },
          orders:    { title: 'ğŸ“¦ è¨‚å–®è¿½è¹¤', subtitle: 'æ¡è³¼èˆ‡åˆ°è²¨é€²åº¦ã€çµæ¡ˆç‹€æ…‹ç®¡ç†' },
          kb:       { title: "ğŸ“š çŸ¥è­˜åº«", subtitle: "FAQï¼æ•…éšœæ¨¡å¼ï¼SOPï¼æ¡ˆä¾‹æŸ¥è©¢" },
          weekly:    { title: 'ğŸ“Š é€±å ±', subtitle: 'æœ¬é€±å·¥ä½œå½™æ•´ï¼ä¸‹é€±è¨ˆç•«' },
          guide:     { title: 'ğŸ“˜ ä½¿ç”¨è€…æŒ‡å—', subtitle: 'å¿«é€Ÿä¸Šæ‰‹ï¼é‡é»æµç¨‹ï¼FAQ' },
          settings:  { title: 'âš™ï¸ è¨­å®š', subtitle: 'é è¨­å€¼ã€Top N é‡˜é¸ã€ç³»çµ±åƒæ•¸' },
        };
        return map[route] || map.repairs;
      }

      _updateHeader(route){
        const meta = this._routeMeta(route);
        const t = document.getElementById('header-title');
        const s = document.getElementById('header-subtitle');
        if (t) t.textContent = meta.title;
        if (s) s.textContent = `${meta.subtitle} Â· ${AppConfig.getFullVersion()}`;
      }
      setActive(route) {
        document.querySelectorAll('[data-route]').forEach(el => {
          el.classList.toggle('active', el.getAttribute('data-route') === route);
        });
      }

      _controllerByRoute(route){
        const r = (route || '').toString().trim();
        const map = {
          repairs: 'RepairController',
          machines: 'MachinesController',
          maintenance: 'MaintenanceController',
          customers: 'CustomerController',
          parts: 'PartsController',
          quotes: 'QuotesController',
          orders: 'OrdersController',
          kb: 'KBController',
          weekly: 'WeeklyController',
          guide: 'GuideController',
          settings: 'SettingsController'
        };
        const key = map[r];
        return key ? window[key] : null;
      }

      _destroyCurrentIfNeeded(nextRoute){
        try {
          const cur = (this.current || '').toString().trim();
          const next = (nextRoute || '').toString().trim();
          if (!cur || cur === next) return;
          const ctrl = this._controllerByRoute(cur);
          if (ctrl && typeof ctrl.destroy === 'function') {
            ctrl.destroy();
          }
        } catch (e) {
          console.warn('Router destroy current failed:', e);
        }
      }
async navigate(route) {
  if (this.isNavigating) return;

  const allowed = ['repairs', 'machines', 'maintenance', 'customers', 'parts', 'quotes', 'orders', 'kb', 'weekly', 'guide', 'settings'];
  if (!allowed.includes(route)) route = 'repairs';

  this.isNavigating = true;
  try {
    // ä¾è·¯ç”±å¥—ç”¨æ¨¡çµ„ Accentï¼ˆé¿å…å…¨ç«™è¦–è¦ºéåº¦å–®èª¿ï¼‰
    try { window.AppTheme?.apply?.(route); } catch (_) {}

    // æ›´æ–°é é¦–ï¼ˆæ¨™é¡Œ/å‰¯æ¨™ï¼‰
    this._updateHeader(route);

	    // æ•ˆèƒ½/ç©©å®šæ€§ï¼šé›¢é–‹èˆŠæ¨¡çµ„æ™‚å…ˆé‡‹æ”¾ UIï¼ˆé¿å…æ®˜ç•™ listener / å®šæ™‚å™¨ï¼‰
	    this._destroyCurrentIfNeeded(route);

	    // æ•ˆèƒ½/ç©©å®šï¼šé›¢é–‹ä¸Šä¸€å€‹æ¨¡çµ„æ™‚å…ˆ destroyï¼Œé¿å…èƒŒæ™¯ç›£è½å™¨/å®šæ™‚å™¨å †ç–Š
	    this._destroyCurrentIfNeeded(route);

    this.setActive(route);

    const host = document.getElementById(this.containerId);
    if (!host) throw new Error('module container not found');

    // å»¶é²è¼‰å…¥ï¼šç¢ºä¿è©²æ¨¡çµ„çš„ UI/Controller/CSS å·²è¼‰å…¥
    try {
      if (window.ModuleLoader && typeof window.ModuleLoader.ensure === 'function') {
        const firstScript = window.ModuleLoader?.manifest?.[route]?.scripts?.[0] || '';
        const alreadyLoaded = !!(firstScript && window.ModuleLoader?._loadedScripts?.has?.(firstScript));
        if (!alreadyLoaded) {
          try { host.innerHTML = '<div style="padding:24px;color:#64748b">è¼‰å…¥ä¸­â€¦</div>'; } catch (_) {}
        }
        await window.ModuleLoader.ensure(route);
      }
    } catch (e) {
      console.error(e);
      host.innerHTML = '<div style="padding:24px;color:#b91c1c">æ¨¡çµ„è¼‰å…¥å¤±æ•—ï¼š' + (e?.message || e) + '</div>';
      return;
    }

    if (route === 'repairs') {
      if (window.RepairController?.reload) {
        await window.RepairController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">ç¶­ä¿®æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'machines') {
      if (window.MachinesController?.reload) {
        await window.MachinesController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">æ©Ÿå°æ­·å²æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'maintenance') {
      if (window.MaintenanceController?.reload) {
        await window.MaintenanceController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">æ©Ÿå°ä¿é¤Šæ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'customers') {
      if (window.CustomerController?.reload) {
        await window.CustomerController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">å®¢æˆ¶æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'kb') {
      if (window.KBController?.reload) {
        await window.KBController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">çŸ¥è­˜åº«æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'weekly') {
      if (window.WeeklyController?.reload) {
        await window.WeeklyController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">é€±å ±æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'guide') {
      if (window.GuideController?.reload) {
        await window.GuideController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">æ“ä½œæŒ‡å—æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'settings') {
      if (window.SettingsController?.reload) {
        await window.SettingsController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">è¨­å®šæ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'parts') {
      if (window.PartsController?.reload) {
        await window.PartsController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">é›¶ä»¶æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'quotes') {
      if (window.QuotesController?.reload) {
        await window.QuotesController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">å ±åƒ¹æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    } else if (route === 'orders') {
      if (window.OrdersController?.reload) {
        await window.OrdersController.reload(this.containerId);
      } else {
        host.innerHTML = '<div style="padding:24px">è¨‚å–®æ¨¡çµ„å°šæœªè¼‰å…¥</div>';
      }
    }

    this.current = route;
    this.currentFeature = route;
  } catch (e) {
    console.error('Router navigate error:', e);
    window.ErrorHandler?.log?.('HIGH', 'Router', 'Navigation failed', { error: e, route });
  } finally {
    this.isNavigating = false;
  }
}
    }

    class MainApp {
      constructor() {
        this.isInitialized = false;
        this._prefBound = false;
      }
      
      /**
       * åˆå§‹åŒ–ä¸»æ‡‰ç”¨
       */
      async init() {
        if (this.isInitialized) return;
        
        try {
          // æ¸²æŸ“ä¸»æ¡†æ¶
          this.renderMainFrame();

          // å¥—ç”¨ä½¿ç”¨è€… UI åå¥½ï¼ˆä¾‹å¦‚åˆ—è¡¨å¯†åº¦ï¼‰
          await this.applyUIPreferences();
          
          // åˆå§‹åŒ– Router
          window.AppRouter = new _AppRouter('main-content');
          // é è¨­é€²å…¥ç¶­ä¿®ç®¡ç†
          await window.AppRouter.navigate('repairs');
          
          this.isInitialized = true;
        } catch (error) {
          console.error('Main App initialization error:', error);
          window.ErrorHandler.log('HIGH', 'MainApp', 'Initialization failed', { error });
        }
      }
      
      /**
       * æ¸²æŸ“ä¸»æ¡†æ¶
       */
      renderMainFrame() {
        const container = document.getElementById('app-container');
        if (!container) return;
        
        container.innerHTML = `
          <div class="app">
            <aside>
              <div class="sidebar-header">
                <div class="sidebar-title">ç¶­ä¿®è¿½è¹¤ç³»çµ± <span class="brand-badge">${AppConfig.VERSION}.${AppConfig.BUILD_NUMBER}</span></div>
                <div class="muted sidebar-sub">${AppConfig.VERSION_NAME}</div>
                <div style="height:10px"></div>
                <div class="user-pill" title="ç™»å…¥ä½¿ç”¨è€…">
                  <div class="user-avatar">${(window.currentUser?.displayName || 'U').trim().slice(0,1).toUpperCase()}</div>
                  <div class="user-name">${window.currentUser?.displayName || 'æœªçŸ¥'}</div>
                </div>
              </div>

              <!-- å°èˆªé¸å–® -->
              <nav class="sidebar-nav">
                <div class="nav-title">åŠŸèƒ½é¸å–®</div>
                <div class="nav-item active" data-route="repairs" onclick="AppRouter.navigate('repairs')">ğŸ“‹ ç¶­ä¿®ç®¡ç†</div>
                <div class="nav-item" data-route="machines" onclick="AppRouter.navigate('machines')">ğŸ–¥ï¸ æ©Ÿå°æ­·å²</div>
                <div class="nav-item" data-route="maintenance" onclick="AppRouter.navigate('maintenance')">ğŸ› ï¸ æ©Ÿå°ä¿é¤Š</div>
                <div class="nav-item" data-route="customers" onclick="AppRouter.navigate('customers')">ğŸ‘¥ å®¢æˆ¶ç®¡ç†</div>
                <div class="nav-item" data-route="parts" onclick="AppRouter.navigate('parts')">ğŸ§© é›¶ä»¶è¿½è¹¤</div>
                <div class="nav-item" data-route="quotes" onclick="AppRouter.navigate('quotes')">ğŸ§¾ å ±åƒ¹</div>
                <div class="nav-item" data-route="orders" onclick="AppRouter.navigate('orders')">ğŸ“¦ è¨‚å–®</div>
                <div class="nav-item" data-route="kb" onclick="AppRouter.navigate('kb')">ğŸ“š çŸ¥è­˜åº«</div>
                <div class="nav-item" data-route="weekly" onclick="AppRouter.navigate('weekly')">ğŸ“Š é€±å ±</div>
                <div class="nav-item" data-route="guide" onclick="AppRouter.navigate('guide')">ğŸ“˜ ä½¿ç”¨è€…æŒ‡å—</div>
                <div class="nav-item" data-route="settings" onclick="AppRouter.navigate('settings')">âš™ï¸ è¨­å®š</div>
              </nav>

              <div class="sidebar-footer">
                <div class="muted">${AppConfig.getFullVersion()}</div>
              </div>
            </aside>
            
            <main>
              <header>
                <div class="header-left">
                  <div id="header-title" class="header-title">ğŸ“‹ ç¶­ä¿®ç®¡ç†</div>
                  <div id="header-subtitle" class="header-subtitle">${AppConfig.getFullVersion()}</div>
                </div>
                <div class="header-right">
                  <button class="btn ghost" onclick="window.logout()">ç™»å‡º</button>
                </div>
              </header>
              
              <div id="main-content" style="flex: 1; overflow-y: auto;">
                <!-- æ¨¡çµ„å°‡åœ¨é€™è£¡æ¸²æŸ“ -->
              </div>
            </main>
          </div>
        `;
        
      }

      setDensity(value){
        const v = (value === 'compact') ? 'compact' : 'comfortable';
        try { document.body.dataset.density = v; } catch (_) {}
      }

      async applyUIPreferences(){
        // é è¨­ï¼šèˆ’é©
        let density = 'comfortable';
        try {
          const ss = (typeof window._svc === 'function' ? window._svc('SettingsService') : window.SettingsService);
          if (ss?.getSettings) {
            const s = await ss.getSettings();
            density = s?.uiDensity || 'comfortable';
          }
        } catch (e) {
          console.warn('applyUIPreferences failed:', e);
        }
        this.setDensity(density);

        // å³æ™‚æ›´æ–°ï¼ˆè¨­å®šå„²å­˜å¾Œç«‹å³ç”Ÿæ•ˆï¼‰
        if (!this._prefBound) {
          this._prefBound = true;
          window.addEventListener('settings:updated', (ev) => {
            this.setDensity(ev?.detail?.uiDensity);
          });
        }
      }
    }
    
    // å»ºç«‹ä¸»æ‡‰ç”¨å¯¦ä¾‹
    const mainApp = new MainApp();
    window.MainApp = mainApp;
    
    // ç›£è½ç™»å…¥æˆåŠŸäº‹ä»¶
    window.addEventListener('auth:login', () => {
      try { window.resetAllServices && window.resetAllServices(); } catch (e) {}
      mainApp.init();
    });
    
    // ç›£è½ç™»å‡ºäº‹ä»¶
    window.addEventListener('auth:logout', () => {
      try { window.resetAllServices && window.resetAllServices(); } catch (e) {}
      try { const c = document.getElementById('app-container'); if (c) c.innerHTML = ''; } catch (e) {}
      mainApp.isInitialized = false;
    });
  </script>
  
  <!-- ========================================
       é–‹ç™¼å·¥å…·ï¼ˆåƒ…é–‹ç™¼æ¨¡å¼ï¼‰
       ======================================== -->
  <script>
    if (AppConfig.isDevelopment()) {
    }
  </script>
</body>
</html>